{"componentChunkName":"component---src-templates-post-js","path":"/notes/faster-netlify-builds/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Faster Netlify builds","date":"2019-02-26T00:00:00.000Z","date_pretty":"February 26th, 2019","date_from_now":"a year ago","last_modified_at":"2019-02-27T02:06:25.000Z","last_modified_at_from_now":"a year ago","path":"/notes/faster-netlify-builds/","author":null,"excerpt":null,"tags":["TIL","Netlify","Jekyll","web development"],"image":null,"toc":null,"comments":true,"comments_locked":null,"hide_meta":null},"id":"edd2fcf9-35e3-5ea1-81c3-be022c3446a8","html":"<p>Slowly but surely, I’ve been chipping away at my site’s <a href=\"/notes/autumn-refresh/#build-and-deploy\">build time on <strong>Netlify</strong></a>.</p>\n<p>There’s little left for me to optimize until Jekyll drops some nice updates in <a href=\"https://github.com/jekyll/jekyll/projects/2\">version 4.0</a>. I’ve <a href=\"https://github.com/mmistakes/made-mistakes-jekyll/issues/629\">cached the rendering of Liquid includes</a> across <code class=\"language-text\">_layouts</code> via the <a href=\"https://github.com/benbalter/jekyll-include-cache\"><code class=\"language-text\">{% include_cached %}</code></a> tag, limited use of <code class=\"language-text\">{% for %}</code> loops over large collections like <code class=\"language-text\">{% site.posts %}</code>, and <a href=\"/articles/using-jekyll-2017/#optimization\">stripped Jekyll’s duties down</a> to solely a HTML generator.</p>\n<p>The “little” that remains, is about <a href=\"https://github.com/mmistakes/made-mistakes-images\">a gigabyte of images</a> I pipe through <strong>Gulp</strong>. Thousands of high resolution images are processed by <a href=\"https://github.com/lovell/sharp\"><strong>Sharp</strong></a> into various sizes. I’ve been able to knock this down from 18 minutes, to six on a fresh build…</p>\n<div class=\"browser-frame\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; background-color: var(--input-background-color); max-width: 1100px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 60.72727272727273%; position: relative; bottom: 0; left: 0; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image lazyload\" alt=\"Screenshot of Netlify&apos;s deploy log for Made Mistakes\" title=\"Screenshot of Netlify&apos;s deploy log for Made Mistakes\" data-src=\"/static/76b95ff095b9c87a136d2eccff341da0/bad3f/netlify-deploy-log.png\" data-srcset=\"/static/76b95ff095b9c87a136d2eccff341da0/39133/netlify-deploy-log.png 275w,\n/static/76b95ff095b9c87a136d2eccff341da0/50322/netlify-deploy-log.png 550w,\n/static/76b95ff095b9c87a136d2eccff341da0/bad3f/netlify-deploy-log.png 1100w,\n/static/76b95ff095b9c87a136d2eccff341da0/32b2a/netlify-deploy-log.png 1190w\" sizes=\"(max-width: 1100px) 100vw, 1100px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</div>\n<p>When building the site locally I store the image artifacts in a temporary folder, and generate new ones if the source changes. When Netlify generates the site it processes these images each build — regardless if they have changed or not.</p>\n<p>By stashing the processed images in a <em>secret</em> Netlify cache folder<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup> and using <a href=\"https://github.com/mmistakes/made-mistakes-jekyll/tree/master/gulp\">Gulp to move files</a> around, I cut the build time in half. Which is fantastic since I’m now averaging 5–8 minutes for dependencies to install, Jekyll to run, and Netlify to deploy the site.</p>\n<p><strong>Excerpt from my Gulp build task</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 'gulp copy:images:cached' -- copies cached images from Netlify's `/opt/build/cache/` folder to `/dist/`</span>\n\ngulp<span class=\"token punctuation\">.</span><span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"copy:images:cached\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> gulp\n    <span class=\"token punctuation\">.</span><span class=\"token function\">src</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">.</span>imageFilesCachePath <span class=\"token operator\">+</span> <span class=\"token string\">\"/**/*\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">newer</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">.</span>imageFilesSite<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>gulp<span class=\"token punctuation\">.</span><span class=\"token function\">dest</span><span class=\"token punctuation\">(</span>paths<span class=\"token punctuation\">.</span>imageFilesSite<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Netlify has an undocumented <code class=\"language-text\">/opt/build/cache/</code> folder that is cached and persists between builds. <a href=\"https://www.contentful.com/blog/2018/05/17/faster-static-site-builds-part-one-process-only-what-you-need/#caching-for-the-win\">Faster static site builds Part 1</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","excerpt":"Slowly but surely, I’ve been chipping away at my site’s build time on Netlify. There’s little left for me to optimize until Jekyll drops…","timeToRead":2,"tableOfContents":""},"comments":{"edges":[]}},"pageContext":{"next":{"frontmatter":{"path":"/notes/twenty-nineteen/","title":"Twenty Nineteen","categories":["notes"],"tags":["life","web development","video games","open source","Jekyll","Gatsby","beard"]},"fileAbsolutePath":"/home/28041/opensource/github.com/mmistakes/made-mistakes-gatsby/src/posts/notes/twenty-nineteen.md"},"previous":{"frontmatter":{"path":"/notes/autumn-refresh/","title":"Autumn refresh","categories":["notes"],"tags":["Jekyll","Gatsby","web development","Netlify"]},"fileAbsolutePath":"/home/28041/opensource/github.com/mmistakes/made-mistakes-gatsby/src/posts/notes/autumn-refresh.md"}}}}