{"componentChunkName":"component---src-templates-post-js","path":"/notes/using-ssi/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Using SSI to detect cookies","date":"2016-10-24T00:00:00.000Z","date_pretty":"October 24th, 2016","date_from_now":"4 years ago","last_modified_at":"2019-11-05T19:50:51.000Z","last_modified_at_from_now":"8 months ago","path":"/notes/using-ssi/","author":null,"excerpt":"In my never ending quest to micro-optimize the hell out of my site, I ran into a snag when trying to use SSI directives to improve the loading of critical CSS and cached stylesheets.","tags":["TIL","web development","Jekyll"],"image":null,"toc":null,"comments":null,"comments_locked":null,"hide_meta":null},"id":"900e8e48-ae13-52ba-a3c1-06ea2b8fc5ae","html":"<p>In my never ending quest to micro-optimize the hell out of my site, I ran into a snag when trying to use <abbr title=\"Server Side Includes\">SSI</abbr> directives.</p>\n<p><a href=\"https://github.com/mmistakes/made-mistakes-jekyll/tree/10.3.0\">Version 10.2</a> of this site was my half-baked attempt at <a href=\"/articles/using-jekyll-2016/#critical-path-css\">eliminating render-blocking CSS</a> to speed up page loads. By manually inlining critical CSS via a <a href=\"http://jekyllrb.com/docs/templates/#includes\">Jekyll include</a> and using <a href=\"https://github.com/filamentgroup/loadCSS\"><strong>loadCSS</strong></a> to asynchronously load the rest — I did pretty good.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; background-color: var(--input-background-color); max-width: 1100px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.72727272727273%; position: relative; bottom: 0; left: 0; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"Made Mistakes version 10 analyzed with Google&#39;s PageSpeed Insights tool\"\n        title=\"Made Mistakes version 10 analyzed with Google&#39;s PageSpeed Insights tool\"\n        data-src=\"/static/b99d0bb875dda3367f23eecf8869d9da/eacc7/mm-home-pagespeed-021116.jpg\"\n        data-srcset=\"/static/b99d0bb875dda3367f23eecf8869d9da/16841/mm-home-pagespeed-021116.jpg 275w,\n/static/b99d0bb875dda3367f23eecf8869d9da/50c97/mm-home-pagespeed-021116.jpg 550w,\n/static/b99d0bb875dda3367f23eecf8869d9da/eacc7/mm-home-pagespeed-021116.jpg 1100w,\n/static/b99d0bb875dda3367f23eecf8869d9da/2e753/mm-home-pagespeed-021116.jpg 1152w\"\n        sizes=\"(max-width: 1100px) 100vw, 1100px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>This workflow wasn’t ideal for a variety of reasons:</p>\n<ol>\n<li>Manual process.</li>\n<li>Need to maintain separate “critical” stylesheets for inlining.</li>\n<li>Included a bunch of declarations that aren’t critical to rendering “above the fold” content — causing some file size bloat.</li>\n</ol>\n<p>So with the help of <a href=\"https://github.com/addyosmani/critical\"><strong>Critical</strong></a> (and friends) I attempted to automated the process. Getting it working within the constraints of a Jekyll site with thousands of posts wasn’t easy, but I got close with <a href=\"https://github.com/mmistakes/made-mistakes-jekyll/tree/master/gulp/tasks\">a set of Gulp tasks</a>. A tale for another day unfortunately…</p>\n<p>Sorry a little off topic there, back to <abbr title=\"Server Side Includes\">SSI</abbr> directives.</p>\n<p>I learned that to speed up things for repeat visitors, loading a cached version of the CSS instead of waiting for <strong>loadCSS</strong> to do its thing was preferred. By using Filament Group’s aptly named <a href=\"https://github.com/filamentgroup/enhance\"><strong>Enhance.js</strong></a> project as a boilerplate, this could be achieved by dropping a cookie and using <abbr title=\"Server Side Includes\">SSI</abbr> directives.</p>\n<p>Structuring our HTML looks a little like like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--#if expr=\"$HTTP_COOKIE=/fullcss\\=true/\" --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>assets/stylesheets/style.css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token comment\">&lt;!--#else--></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n     <span class=\"token comment\">/* critical path CSS styles go here... */</span>\n  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\n<span class=\"token comment\">&lt;!--#endif--></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>noscript</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>assets/stylesheets/style.css<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>noscript</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The <code class=\"language-text\">#if</code> and <code class=\"language-text\">#else</code> conditionals are <abbr title=\"Server Side Includes\">SSI</abbr> directives used by Apache to do some neat things. In this context they determine if a cookie named <code class=\"language-text\">fullcss</code> has been set. If it has, cached CSS files will load using a standard <code class=\"language-text\">&lt;link&gt;</code> element. If it hasn’t, the inline CSS will be rendered by the browser instead.</p>\n<p>For first time visitors:</p>\n<ol>\n<li>Critical CSS inlined within the <code class=\"language-text\">&lt;style&gt;</code> element will load almost instantly.</li>\n<li><strong>loadCSS</strong> script will asynchronously load the remaining page CSS as not to block rendering.</li>\n<li>A cookie will be set to trigger the loading of cached CSS on future page loads.</li>\n</ol>\n<p>After setting all this up and testing my pages against <a href=\"https://www.webpagetest.org/\"><strong>WebPagetest</strong></a>, <a href=\"https://developers.google.com/speed/pagespeed/insights/\"><strong>PageSpeed Insights</strong></a>, and <a href=\"https://gtmetrix.com/\"><strong>GTmetrix</strong></a> I saw an obvious drop in scrores. Apparently the <abbr title=\"Server Side Includes\">SSI</abbr> directives weren’t working as intended, causing <code class=\"language-text\">style.css</code> to render block each page load. Hmmmm…</p>\n<p>Oh right, maybe it’s Cloudflare’s <strong>Auto Minifying</strong> setting mucking around! Sure enough, as soon I disabled their HTML minifier, lines like <code class=\"language-text\">&lt;!--#if expr=&quot;$HTTP_COOKIE=/fullcss\\=true/&quot; --&gt;</code> remained untouched. Unfortunately <code class=\"language-text\">style.css</code> was still render blocking the page.</p>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; background-color: var(--input-background-color); max-width: 999px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 26.18181818181818%; position: relative; bottom: 0; left: 0; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image lazyload\" alt=\"screenshot of Cloudflare&apos;s Auto Minify settings\" title=\"screenshot of Cloudflare&apos;s Auto Minify settings\" data-src=\"/static/66b4d4d081dda2721a6a40b5971cdf83/7eae9/cloudflare-auto-minify.jpg\" data-srcset=\"/static/66b4d4d081dda2721a6a40b5971cdf83/16841/cloudflare-auto-minify.jpg 275w,\n/static/66b4d4d081dda2721a6a40b5971cdf83/50c97/cloudflare-auto-minify.jpg 550w,\n/static/66b4d4d081dda2721a6a40b5971cdf83/7eae9/cloudflare-auto-minify.jpg 999w\" sizes=\"(max-width: 999px) 100vw, 999px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption><p>Auto Minify removes unnecessary characters from your source code (like extraneous whitespace and comments).</p></figcaption>\n</figure>\n<p>Dug a little deeper and discovered you have to configure your server to <a href=\"http://httpd.apache.org/docs/current/howto/ssi.html#configuring\">permit <abbr title=\"Server Side Includes\">SSI</abbr></a> before they’ll be recognized. Oops! Dropped these two lines in my <code class=\"language-text\">.htaccess</code> file and everything magically worked.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Options +Includes\nAddHandler server-parsed .shtml .html .htm</code></pre></div>\n<figure>\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; background-color: var(--input-background-color); max-width: 1049px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 69.81818181818181%; position: relative; bottom: 0; left: 0; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image lazyload\" alt=\"Google PageSpeed Insights score screenshot\" title=\"Google PageSpeed Insights score screenshot\" data-src=\"/static/227c55cbe95bb1a3a7e1890a6f857fe5/0aed9/pagespeed-insights-99-100.jpg\" data-srcset=\"/static/227c55cbe95bb1a3a7e1890a6f857fe5/16841/pagespeed-insights-99-100.jpg 275w,\n/static/227c55cbe95bb1a3a7e1890a6f857fe5/50c97/pagespeed-insights-99-100.jpg 550w,\n/static/227c55cbe95bb1a3a7e1890a6f857fe5/0aed9/pagespeed-insights-99-100.jpg 1049w\" sizes=\"(max-width: 1049px) 100vw, 1049px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n  <figcaption><p>So close to 100. If it wasn&apos;t for the Google Analytics and AdSense scripts&#x2026;</p></figcaption>\n</figure>","excerpt":"In my never ending quest to micro-optimize the hell out of my site, I ran into a snag when trying to use SSI directives. Version 10.2 of…","timeToRead":3,"tableOfContents":""},"comments":{"edges":[]}},"pageContext":{"next":{"frontmatter":{"path":"/notes/css-blur-effect/","title":"CSS blur effect","categories":["notes"],"tags":["TIL","web development"]},"fileAbsolutePath":"/home/28041/opensource/github.com/mmistakes/made-mistakes-gatsby/src/posts/notes/css-blur-effect.md"},"previous":{"frontmatter":{"path":"/notes/inktober-2016-failure/","title":"Inktober failure","categories":["notes"],"tags":["watercolor","portrait","illustration","Inktober"]},"fileAbsolutePath":"/home/28041/opensource/github.com/mmistakes/made-mistakes-gatsby/src/posts/notes/inktober-2016-failure.md"}}}}